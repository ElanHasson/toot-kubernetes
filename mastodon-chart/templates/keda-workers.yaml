{{ if .Values.keda.workers.enabled }}
{{- $context := . }}
{{- range .Values.keda.workers.queues }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  labels:
    {{- include "mastodon.labels" $context | nindent 4 }}
    scaledobject.keda.sh/name: {{ include "mastodon.fullname" $context }}-sidekiq-{{ .name }}
  name: {{ include "mastodon.fullname" $context }}-sidekiq-{{ .name }}
spec:
  cooldownPeriod: {{ .cooldownPeriod | default $context.Values.keda.workers.cooldownPeriod }}
  minReplicaCount: {{ .minReplicaCount | default $context.Values.keda.workers.minReplicaCount }}
  maxReplicaCount: {{ .maxReplicaCount | default $context.Values.keda.workers.maxReplicaCount }}
  pollingInterval: {{ .pollingInterval | default $context.Values.keda.workers.pollingInterval }}
  scaleTargetRef:
    name: {{ include "mastodon.fullname" $context }}-sidekiq-{{ .name }}
  {{- if $context.Values.keda.workers.fallback.enabled }}
  fallback:
    replicas: {{ $context.Values.keda.workers.fallback.replicas }}
    failureThreshold: {{ $context.Values.keda.workers.fallback.failureThreshold }}
  {{- end }}
  triggers:
    - type: redis
      metadata:
        address: {{ $context.Values.keda.redis.address }}
        listName: "queue:{{ .queue }}"
        listLength: {{ .threshold | quote }}
        enableTLS: {{ $context.Values.keda.redis.tls.enabled | quote }}
        databaseIndex: {{ $context.Values.keda.redis.index | quote }}
        {{- if .activationThreshold }}
        activationListLength: {{ .activationThreshold | quote }}
        {{- end }}
      authenticationRef:
        name: {{ include "mastodon.fullname" $context }}-worker-redis-auth
  advanced:
    {{- if $context.Values.keda.workers.advanced }}
    {{- toYaml $context.Values.keda.workers.advanced | nindent 4 }}
    {{- end }}
{{ end}}
{{ end }}
